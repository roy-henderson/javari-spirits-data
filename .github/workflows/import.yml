name: Javari Spirits Data Import

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      full_import:
        description: 'Run full import (all datasets)'
        required: false
        default: 'true'
        type: boolean
  
  # Scheduled - runs weekly on Sundays at 3 AM ET
  schedule:
    - cron: '0 8 * * 0'  # 8 AM UTC = 3 AM ET
  
  # Trigger on push to main (for initial setup)
  push:
    branches: [main]
    paths:
      - 'import-all.cjs'
      - '.github/workflows/import.yml'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify Supabase connection
        run: |
          node -e "
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
            supabase.from('products').select('*', { count: 'exact', head: true })
              .then(r => {
                if (r.error) throw new Error(r.error.message);
                console.log('✅ Connected to Supabase. Current products:', r.count);
              })
              .catch(e => {
                console.error('❌ Connection failed:', e.message);
                process.exit(1);
              });
          "
      
      - name: Run data import
        run: node import-all.cjs
      
      - name: Generate import report
        if: always()
        run: |
          echo "## Javari Spirits Import Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(TZ='America/New_York' date '+%Y-%m-%d %H:%M:%S ET')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get final count
          COUNT=$(node -e "
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
            supabase.from('products').select('*', { count: 'exact', head: true })
              .then(r => console.log(r.count || 0));
          " 2>/dev/null || echo "unknown")
          
          echo "**Total Products in Database:** $COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Javari Spirits import failed. Check logs for details."

  # Optional: Notify Javari AI of completion
  notify:
    needs: import
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send webhook notification
        if: ${{ secrets.JAVARI_WEBHOOK_URL != '' }}
        run: |
          curl -X POST "${{ secrets.JAVARI_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "data_import_complete",
              "status": "${{ needs.import.result }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "source": "github_actions"
            }' || true
